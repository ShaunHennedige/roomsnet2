<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROOMSNET</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="checkavailability.css">
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts Link For Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <script src="script.js" defer></script>
    <!-- Favicons-->
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <!-- GOOGLE WEB FONT-->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500&amp;family=Montserrat:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>
<body>
    <header class="navbar navbar-light bg-light shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <img src="system/images/ROOMSNET-removebg-preview.png" alt="ROOMSNET Logo" style="width: 150px; height: auto;">
            </a>
            <select class="form-select w-auto" id="currency-selector">
                <!-- Options will be populated dynamically -->
            </select>
        </div>
    </header>
   
     <!-- Hotel Details and Map Section -->
     <div class="container">
        <div class="hotel-container">
            <!-- Hotel Details and Images -->
            <div class="hotel-details">
                <h2 id="hotelName">Fetching Hotel Name...</h2>
                <p id="hotelAddress" class="address-container"><i class="bi bi-geo-alt"></i> Fetching Hotel Address...</p>

                 <!-- Hotel Images Section -->
                 <div class="hotel-images" id="image-grid">
                    <!-- Images will be appended here by JavaScript -->
                </div>
                <!-- Carousel for Mobile View -->
                <div id="hotelImagesCarousel" class="carousel slide d-md-none" data-bs-ride="carousel">
                    <div class="carousel-inner" id="carousel-images">
                        <!-- Carousel images will be appended here by JavaScript for mobile view -->
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#hotelImagesCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#hotelImagesCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>

            <!-- Map Section -->
<div class="map-container">
    <br><br>
    <iframe allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
    </iframe>
    <a href="#" target="_blank">
        <button class="show-map-btn">Show on map</button>
    </a>
</div>

        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

    <div class="container mt-4">
        <div class="row justify-content-center g-3">
            <div class="col-md-6 col-lg-4">
                <div class="input-group">
                    <input type="text" class="form-control" id="daterange" name="daterange" placeholder="Select Date Range">
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="d-flex align-items-center" id="check-availability-container">
                    <button class="btn btn-primary w-100" id="check-availability-btn" onclick="checkAvailability()">Check Availability</button>
                </div>
            </div>
        </div>
    </div>

    <main class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <div id="room-cards"></div>
                <center>
                    <span id="check-availability-text" class="ms-5">
                        Kindly select a date/date range to find availability
                    </span>
                </center>
            </div>
            
            <div class="col-lg-4" id="reservation-column">
                <button class="btn btn-close position-absolute top-0 end-0 m-2 d-lg-none" id="close-reservation-btn" onclick="hideFullReservation()"></button>
                <div class="card" id="reservation-card">
                    <div class="card-body">
                        <h5 class="card-title">Your Reservation</h5>
                        <div id="reservation-list"></div>
                        <div id="total-display" class="fw-bold mt-3">
                            <p>Total: <span id="total-currency">LKR</span> <span id="total-amount">0</span> (Tax inclusive)</p>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0 p-0">
                        <button class="btn btn-primary w-100" onclick="proceedToBilling()">Proceed to Billing</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="floating-reservation-summary" class="d-none d-lg-none">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="reservation-count">0</span> room(s) selected
                </div>
                <div>
                    Total: <span id="floating-total-currency">LKR</span> <span id="floating-total-amount">0</span>
                </div>
                <button class="btn btn-primary btn-sm" onclick="showFullReservation()">View Reservation</button>
            </div>
        </div>
    </div>

    <footer class="bg-light text-center text-lg-start mt-4">
        <div class="container p-4">
            <div class="text-center">
                <span>ROOMSNET &copy;
                    <script>
                        var d = new Date();
                        document.write(d.getFullYear());
                    </script>
                </span>
                <a href="bookingpolicy.html">&nbsp; Booking Policy</a>
                <a href="contact.html">&nbsp; Contact Us</a>
            </div>
        </div>

         <!-- <button class="chatbot-toggler">
        <span class="material-symbols-rounded">mode_comment</span>
        <span class="material-symbols-outlined">close</span>
    </button>
    <div class="chatbot">
        <header>
            <h2>Ask Me Anything</h2>
            <span class="close-btn material-symbols-outlined">close</span>
        </header>
        <ul class="chatbox">
            <li class="chat incoming">
                <span class="material-symbols-outlined">smart_toy</span>
                <p>Hi there ðŸ‘‹<br>How can I help you today?</p>
            </li>
        </ul>
        <div class="chat-input">
            <textarea placeholder="Enter a message..." spellcheck="false" required></textarea>
            <span id="send-btn" class="material-symbols-rounded">send</span>
        </div>
    </div> -->

    <div class="whatsapp-chat"></div>
    <a href="https://api.whatsapp.com/send?phone=" id="whatsapp-link" target="_blank" class="whatsapp-button">
        <i class="bx bxl-whatsapp"></i> <!-- Boxicons WhatsApp icon -->
    </a>

    </div>
    </footer>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <!-- Inline JavaScript -->
    <script>
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        document.onkeydown = function(e) {
            if (e.keyCode == 123 || e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
        };
        

        // Function to fetch hotel data and update map
async function loadHotelMap() {
    try {
        const response = await fetch('https://demo.citrusibe.com/API/GetHotelDetail.aspx');
        const hotelData = await response.json();
        
        // Extract the necessary data from the response
        const embedMap = hotelData.EmbedMap; // Assuming EmbedMap contains the iframe URL
        const googleMapURL = hotelData.GoogleMapURL; // Assuming GoogleMapURL contains the map link

        // Update the iframe src attribute with the EmbedMap value
        const iframe = document.querySelector('.map-container iframe');
        iframe.src = embedMap;

        // Update the button href attribute with the GoogleMapURL value
        const showMapButton = document.querySelector('.show-map-btn');
        showMapButton.parentElement.href = googleMapURL;

    } catch (error) {
        console.error('Error fetching hotel data:', error);
    }
}

// Call the function when the page loads
window.onload = loadHotelMap;

        document.addEventListener('DOMContentLoaded', function() {
            fetchWhatsAppNumber();
        });

        function fetchWhatsAppNumber() {
            fetch('https://demo.citrusibe.com/API/GetHotelDetail.aspx')
                .then(response => response.json())
                .then(data => {
                    const whatsappLink = document.getElementById('whatsapp-link');

                    // Set the WhatsApp number dynamically
                    if (data.WhatsAppNo) {
                        whatsappLink.href = `https://api.whatsapp.com/send?phone=${data.WhatsAppNo}`;
                    } else {
                        console.error('WhatsApp number not found in API response.');
                    }
                })
                .catch(error => console.error('Error fetching WhatsApp number:', error));
        }

        let exchangeRates = {};
        let selectedDateRange = null;
        let roomData = [];
        
        $(document).ready(function() {
            // Fetch exchange rates and initialize the currency selector and prices
            fetch('https://open.er-api.com/v6/latest/LKR')
                .then(response => response.json())
                .then(data => {
                    exchangeRates = data.rates;
                    updateCurrencySelector();
                    updatePrices();
                })
                .catch(error => console.error('Error fetching exchange rates:', error));
        
            $('#currency-selector').on('change', updatePrices);
        
            // Initialize the date range picker
            $('input[name="daterange"]').daterangepicker({
                opens: 'left',
                minDate: moment(),
                startDate: moment(),
                endDate: moment().add(1, 'days'),
                locale: {
                    format: 'YYYY-MM-DD'
                }
            }, function(start, end) {
                selectedDateRange = {
                    start: start.format('YYYY-MM-DD'),
                    end: end.format('YYYY-MM-DD')
                };
            });
            
            selectedDateRange = {
                start: moment().format('YYYY-MM-DD'),
                end: moment().add(1, 'days').format('YYYY-MM-DD')
            };
    
           // Event listener for changing the number of children
// Event listener for changing the number of children
$(document).on('change', '.children-input', function() {
    const card = $(this).closest('.room-card');
    const childrenCount = parseInt($(this).val());
    const roomId = card.data('roomid');
    const mealPlan = card.data('mealplan');
    const childAgeContainer = card.find(`#child-age-container-${roomId}-${mealPlan}`);
    
    // Clear previous inputs
    childAgeContainer.empty();
    
    // Add child age dropdowns based on the number of children
    for (let i = 0; i < childrenCount; i++) {
        childAgeContainer.append(`
            <div class="row g-2 align-items-center mb-2">
                <div class="col-auto">
                    <label for="child-age-${roomId}-${mealPlan}-${i}" class="col-form-label">Child Age ${i + 1}:</label>
                </div>
                <div class="col-auto">
                    <select id="child-age-${roomId}-${mealPlan}-${i}" class="form-select child-age-dropdown">
                        ${generateAgeOptions()}
                    </select>
                </div>
            </div>
        `);
    }

    // Update room price as soon as the number of children changes
    updateRoomPrice(card);
});

// Generate age options for children (0-18 years)
function generateAgeOptions() {
    let options = '';
    for (let age = 0; age <= 18; age++) {
        options += `<option value="${age}">${age}</option>`;
    }
    return options;
}

// Ensure that child age dropdown changes trigger a price update
$(document).on('change', '.child-age-dropdown', function() {
    const card = $(this).closest('.room-card');
    updateRoomPrice(card);
});


            // Event listener for adding a reservation
            $(document).on('click', '.add-reservation', function() {
                const card = $(this).closest('.room-card');
                addToReservation(card);
            });
        
            // Event listener for removing a reservation
            $(document).on('click', '.remove-reservation', function() {
                removeReservation($(this));
            });
        
            // Handle window resize for reservation summary
            $(window).resize(function() {
                if (window.innerWidth > 991) {
                    $('#reservation-column').show();
                    $('#floating-reservation-summary').addClass('d-none');
                } else {
                    $('#reservation-column').hide();
                    updateFloatingReservationSummary();
                }
            });
        
            updateFloatingReservationSummary();
        });
        
        // Populate the currency selector with fetched exchange rates
        function updateCurrencySelector() {
            const currencySelector = $('#currency-selector');
            currencySelector.empty(); // Clear existing options
            Object.keys(exchangeRates).forEach(currency => {
                currencySelector.append(`<option value="${currency}">${currency}</option>`);
            });
        }
        
        // Update prices for all room cards based on selected currency and child ages
        function updatePrices() {
            $('.room-card').each(function() {
                updateRoomPrice($(this));
            });
            updateTotalAmount();
        }
        
        // Function to calculate the price based on child age and apply appropriate rates
function updateRoomPrice(card) {
    const roomId = card.data('roomid');
    const mealPlan = card.data('mealplan');
    const room = roomData.find(r => r.roomtypeid == roomId && r.mealplan == mealPlan);
    if (!room) return;

    const adults = parseInt(card.find('.adults-input').val());
    const children = parseInt(card.find('.children-input').val());

    // Collect child ages from input fields (dropdowns)
    const childAges = [];
    card.find('.child-age-dropdown').each(function() {
        const age = parseInt($(this).val());
        childAges.push(isNaN(age) ? 0 : age);
    });

    // Determine base price based on number of adults
    let basePrice;
    switch (adults) {
        case 1: basePrice = parseFloat(room.singlerate); break;
        case 2: basePrice = parseFloat(room.doublerate); break;
        case 3: basePrice = parseFloat(room.triplerate); break;
        case 4: basePrice = parseFloat(room.qdplrate); break;
        case 5: basePrice = parseFloat(room.familyerate); break;
        default: basePrice = parseFloat(room.doublerate);
    }

    let childrenPrice = 0;

    // Apply rate based on the child's age
    childAges.forEach(age => {
        if (age <= 6) {
            // Apply child rate for ages 0-6
            childrenPrice += parseFloat(room.childrate);
        } else if (age >= 7) {
            // Apply extra adult rate for ages 7 and above
            childrenPrice += parseFloat(room.exadultrate);
        }
    });

    const totalPrice = basePrice + childrenPrice;

    // Convert the total price based on the selected currency
    const selectedCurrency = $('#currency-selector').val();
    const selectedRate = exchangeRates[selectedCurrency] || 1; // Default to 1 if not found
    const convertedPrice = (totalPrice / exchangeRates['USD']) * selectedRate;

    // Update the price display
    card.find('.price').text(`${selectedCurrency} ${convertedPrice.toFixed(2)} Per Period`);
    card.find('.price').data('price', totalPrice);
}

        
        // Fetch and display room features
        function fetchRoomFeatures(roomTypeId, card) {
            $.ajax({
                url: `https://demo.citrusibe.com/API/GetRoomFeatures.aspx?roomtypeid=${roomTypeId}`,
                dataType: 'json',
                success: function(data) {
                    const featureList = card.find('.room-features');
                    let features = '';
                    data.forEach(function(feature) {
                        features += `<span class="text-success">âœ“</span> ${feature.feature} `;
                    });
                    featureList.html(`<p>${features}</p>`);
                },
                error: function() {
                    card.find('.room-features').html('<p>No features available.</p>');
                }
            });
        }
        
        // Fetch room rates based on selected date range
        function fetchRoomRates(dateFrom, dateTo) {
            $('#room-cards').empty();
            $.ajax({
                url: `https://demo.citrusibe.com/API/GetRoomRates.aspx?datefrom=${dateFrom}&dateto=${dateTo}&currency=US$`,
                dataType: 'json',
                success: function(data) {
                    roomData = data;
                    if (data.length === 0) {
                        $('#room-cards').html('<p class="text-center">No rooms available for the selected dates.</p>');
                        return;
                    }
                    data.forEach(function(room) {
                        const card = $(`
                            <div class="card mb-4 room-card" data-roomid="${room.roomtypeid}" data-mealplan="${room.mealplan}">
                                <div class="position-absolute top-0 end-0 bg-danger text-white px-2 py-1 rounded m-2">
                                    ${room.discount}% OFF
                                </div>
                                <div class="row g-0">
                                    <div class="col-md-4">
                                        <img src="${room.mainimageurl}" class="img-fluid rounded-start card-img" alt="${room.roomtype}">
                                    </div>
                                    <div class="col-md-8">
                                        <div class="card-body">
                                            <h5 class="card-title">${room.roomtype} - ${room.mealplandesc}</h5>
                                            <div class="room-features small mb-2"></div>
                                            <div class="room-capacity d-flex align-items-center mt-2">
                                                <span class="me-2">Room Capacity: ${room.maxoccupancy}</span>
                                                <div class="capacity-icons">
                                                    ${'ðŸ‘¨'.repeat(room.maxadult)}
                                                    ${'ðŸ‘¶'.repeat(room.maxchild)}
                                                </div>
                                            </div>
                                            <div class="available-rooms mt-2">
                                                 <span class="badge ${room.maxavailable <=5 ? 'bg-warning' : 'bg-info'}">
                                                    ${room.maxavailable <=5 ? `Only ${room.maxavailable} room${room.maxavailable !== 1 ? 's' : ''} available` : `Available Rooms: ${room.maxavailable}`}
                                                </span>
                                            </div>
                                            <div class="mt-3">
                                                <div class="row g-2 align-items-center">
                                                    <div class="col-auto">
                                                        <label for="adults-${room.roomtypeid}-${room.mealplan}" class="col-form-label">Adults:</label>
                                                    </div>
                                                    <div class="col-auto">
                                                        <select id="adults-${room.roomtypeid}-${room.mealplan}" class="form-select form-select-sm adults-input">
                                                            ${generateOptions(1, room.maxadult, 2)}
                                                        </select>
                                                    </div>
                                                    <div class="col-auto">
                                                        <label for="children-${room.roomtypeid}-${room.mealplan}" class="col-form-label">Children:</label>
                                                    </div>
                                                    <div class="col-auto">
                                                        <select id="children-${room.roomtypeid}-${room.mealplan}" class="form-select form-select-sm children-input">
                                                            ${generateOptions(0, room.maxchild)}
                                                        </select>
                                                    </div>
                                                </div>
        
                                                <!-- Child age inputs will be added dynamically here -->
                                                <div id="child-age-container-${room.roomtypeid}-${room.mealplan}"></div>
                                            </div>
        
                                            <div class="d-flex justify-content-between align-items-center mt-3">
                                                <button class="btn btn-primary btn-sm add-reservation">Reserve this room</button>
                                                <span class="price text-success fw-bold" data-price="${room.doublerate}">LKR ${room.doublerate} Per Night</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`);
                        $('#room-cards').append(card);
                        fetchRoomFeatures(room.roomtypeid, card);
                    });
                    updatePrices();
                },
                error: function() {
                    $('#room-cards').html('<p class="text-center text-danger">Failed to load room rates. Please try again later.</p>');
                }
            });
        }
        
        // Generate options for select inputs
        function generateOptions(start, end, defaultValue = null) {
            let options = '';
            for (let i = start; i <= end; i++) {
                options += `<option value="${i}"${i === defaultValue ? ' selected' : ''}>${i}</option>`;
            }
            return options;
        }
        
        // Add selected room to reservation list
        function addToReservation(card) {
            if (!selectedDateRange) {
                alert('Please select a date range first.');
                return;
            }
        
            const roomId = card.data('roomid');
            const mealPlan = card.data('mealplan');
            const room = roomData.find(r => r.roomtypeid == roomId && r.mealplan == mealPlan);
            if (!room) {
                console.error('Room not found');
                return;
            }
        
            const availableRoomsElement = card.find('.available-rooms .badge');
            let availableRooms;
            if (availableRoomsElement.text().includes('Only')) {
                availableRooms = parseInt(availableRoomsElement.text().match(/\d+/)[0]);
            } else {
                availableRooms = parseInt(availableRoomsElement.text().split(': ')[1]);
            }
        
            if (availableRooms <= 0) {
                alert('No more rooms available for this type.');
                return;
            }
        
            const newAvailableRooms = availableRooms - 1;
        
            // Update all cards with the same room type
            $('.room-card').each(function() {
                const otherCard = $(this);
                const otherRoomId = otherCard.data('roomid');
                const otherRoom = roomData.find(r => r.roomtypeid == otherRoomId);
        
                if (otherRoom && otherRoom.roomtypeid == room.roomtypeid) {
                    updateRoomCount(otherCard, newAvailableRooms);
                }
            });
        
            const adults = parseInt(card.find('.adults-input').val());
            const children = parseInt(card.find('.children-input').val());
            const checkIn = selectedDateRange.start;
            const checkOut = selectedDateRange.end;
            const selectedCurrency = $('#currency-selector').val();
            
            if (!exchangeRates[selectedCurrency]) {
                console.error('Exchange rate not available');
                return;
            }
            
            const selectedRate = exchangeRates[selectedCurrency];
            const totalPrice = parseFloat(card.find('.price').data('price'));
            const convertedPrice = (totalPrice / exchangeRates['USD']) * selectedRate;
        
            // Collect child ages
            const childAges = [];
            card.find('.child-age-input').each(function() {
                const age = parseInt($(this).val());
                childAges.push(isNaN(age) ? 0 : age);
            });
        
            const reservationDetails = {
                roomId: roomId,
                mealPlan: mealPlan,
                roomType: room.roomtype,
                mealPlanDesc: room.mealplandesc,
                adults: adults,
                children: children,
                childAges: childAges,
                checkIn: checkIn,
                checkOut: checkOut,
                currency: selectedCurrency,
                amount: convertedPrice.toFixed(2)
            };
        
            let reservations = JSON.parse(localStorage.getItem('reservations')) || [];
            reservations.push(reservationDetails);
            localStorage.setItem('reservations', JSON.stringify(reservations));
        
            const reservationCard = `
            <div class="reservation-item mb-3 card" data-roomid="${roomId}" data-mealplan="${mealPlan}">
                <div class="card-body">
                    <h5 class="card-title">${room.roomtype}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">${room.mealplandesc}</h6>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <p class="card-text"><i class="bi bi-person"></i> ${adults} Adults, ${children} Children</p>
                            ${children > 0 ? `<p class="card-text">Child Ages: ${childAges.join(', ')}</p>` : ''}
                        </div>
                        <div class="col-6">
                            <p class="card-text"><i class="bi bi-calendar-check"></i> ${checkIn} - ${checkOut}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="card-text fw-bold">${selectedCurrency} ${convertedPrice.toFixed(2)}</p>
                        <button class="btn btn-outline-danger btn-sm remove-reservation" data-price="${convertedPrice}">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </div>
                </div>
            </div>
            `;
        
            $('#reservation-list').append(reservationCard);
        
            updateTotalAmount();
            updateFloatingReservationSummary();
        }
        
        // Remove a reservation from the list
        function removeReservation(button) {
            const card = button.closest('.reservation-item');
            const roomId = card.data('roomid');
            const mealPlan = card.data('mealplan');
            card.remove();
        
            const originalCard = $(`.room-card[data-roomid="${roomId}"][data-mealplan="${mealPlan}"]`);
            const availableRoomsElement = originalCard.find('.available-rooms .badge');
            let currentCount;
            if (availableRoomsElement.text().includes('Only')) {
                currentCount = parseInt(availableRoomsElement.text().match(/\d+/)[0]);
            } else {
                currentCount = parseInt(availableRoomsElement.text().split(': ')[1]);
            }
            updateRoomCount(originalCard, currentCount + 1);
        
            let reservations = JSON.parse(localStorage.getItem('reservations')) || [];
            reservations = reservations.filter(r => !(r.roomId == roomId && r.mealPlan == mealPlan));
            localStorage.setItem('reservations', JSON.stringify(reservations));
        
            updateTotalAmount();
            updateFloatingReservationSummary();
        }
        
        // Update the available room count display
        function updateRoomCount(card, count) {
            const badgeElement = card.find('.available-rooms .badge');
            if (count <= 5) {
                badgeElement.removeClass('bg-info').addClass('bg-warning');
                badgeElement.text(`Only ${count} room${count !== 1 ? 's' : ''} available`);
            } else {
                badgeElement.removeClass('bg-warning').addClass('bg-info');
                badgeElement.text(`Available Rooms: ${count}`);
            }
        
            const reserveButton = card.find('.add-reservation');
            if (count <= 0) {
                reserveButton.prop('disabled', true).text('No rooms available');
            } else {
                reserveButton.prop('disabled', false).text('Reserve this room');
            }
        }
        
        // Update the total reservation amount
        function updateTotalAmount() {
            const selectedCurrency = $('#currency-selector').val();
            let totalAmount = 0;
            $('.reservation-item').each(function() {
                totalAmount += parseFloat($(this).find('.remove-reservation').data('price'));
            });
            $('#total-amount').text(totalAmount.toFixed(2));
            $('#total-currency').text(selectedCurrency);
            $('#floating-total-amount').text(totalAmount.toFixed(2));
            $('#floating-total-currency').text(selectedCurrency);
        }
        
        // Update the floating reservation summary for smaller screens
        function updateFloatingReservationSummary() {
            const reservationCount = $('#reservation-list').children().length;
            $('#reservation-count').text(reservationCount);
            
            if (reservationCount > 0) {
                $('#floating-reservation-summary').removeClass('d-none');
            } else {
                $('#floating-reservation-summary').addClass('d-none');
            }
        }
        
        // Show the full reservation column
        function showFullReservation() {
            $('#reservation-column').show();
            $('body').addClass('reservation-open');
            if (window.innerWidth <= 991) {
                $('#close-reservation-btn').show();
            }
        }
        
        // Hide the full reservation column
        function hideFullReservation() {
            $('#reservation-column').hide();
            $('#close-reservation-btn').hide();
            $('body').removeClass('reservation-open');
        }
        
        // Check availability based on selected date range
        function checkAvailability() {
            if (selectedDateRange) {
                const dateFrom = moment(selectedDateRange.start).format('M/D/YYYY');
                const dateTo = moment(selectedDateRange.end).format('M/D/YYYY');
                fetchRoomRates(dateFrom, dateTo);
    
                $('#check-availability-text').hide();
            } else {
                alert('Please select a date range first.');
            }
        }

        async function fetchHotelDetails() {
            try {
                const response = await fetch('https://api.allorigins.win/get?url=https://demo.citrusibe.com/API/GetHotelDetail.aspx');
                const data = await response.json();
                const cleanData = cleanJSON(data.contents);
                const hotelData = JSON.parse(cleanData);

                document.getElementById('hotelName').textContent = hotelData.HotelName || 'Hotel Name Unavailable';
                document.getElementById('hotelAddress').textContent = hotelData.Address || 'Address Unavailable';
            } catch (error) {
                console.error('Error fetching hotel details:', error);
            }
        }

        function fetchHotelImages() {
            fetch('https://demo.citrusibe.com/API/GetHotelImages.aspx')
                .then(response => response.json())
                .then(data => {
                    const imageGrid = document.getElementById('image-grid');
                    const largeImageClass = 'image-large'; // Class for the large image
                    const gridClasses = ['image2', 'image3', 'image4', 'image5', 'image6']; // Classes for the smaller images
        
                    // Clear any previous images in the grid
                    imageGrid.innerHTML = '';
        
                    // Ensure there's at least one image to set as the large image
                    if (data.length > 0) {
                        const largeImageElement = document.createElement('img');
                        largeImageElement.src = data[0].URL;  // Set the first image as large
                        largeImageElement.classList.add('img-fluid', largeImageClass);
                        largeImageElement.alt = 'Large Image';
                        imageGrid.appendChild(largeImageElement); // Append large image to grid
                    }
        
                    // Add remaining images to the grid as smaller images
                    data.slice(1, 6).forEach((imageData, index) => {
                        const imgElement = document.createElement('img');
                        imgElement.src = imageData.URL;
                        imgElement.classList.add('img-fluid', gridClasses[index], 'image-small');
                        imgElement.alt = `Small Image ${index + 1}`;
                        imageGrid.appendChild(imgElement);
                    });
        
                    // Attach click event listeners for image swapping
                    attachImageSwapListeners();
                })
                .catch(error => {
                    console.error('Error fetching images:', error);
                });
        }
        
        // Attach click event listeners to swap images
        function attachImageSwapListeners() {
            const largeImage = document.querySelector('.image-large');  // Select the large image
            const smallImages = document.querySelectorAll('.image-small'); // Select all small images
        
            smallImages.forEach(smallImage => {
                smallImage.addEventListener('click', function() {
                    // Swap the large image's src with the clicked small image's src
                    const tempSrc = largeImage.src;
                    const tempAlt = largeImage.alt;
        
                    largeImage.src = smallImage.src;
                    largeImage.alt = smallImage.alt;
        
                    smallImage.src = tempSrc;
                    smallImage.alt = tempAlt;
                });
            });
        } 
        function fetchHotelImages1() {
            fetch('https://demo.citrusibe.com/API/GetHotelImages.aspx')
                .then(response => response.json())
                .then(data => {
                    const imageGrid = document.getElementById('image-grid');
                    const carouselImages = document.getElementById('carousel-images');
        
                    data.forEach((imageData, index) => {
                        // Add image to the carousel (for mobile view)
                        const carouselItem = document.createElement('div');
                        carouselItem.classList.add('carousel-item');
                        if (index === 0) carouselItem.classList.add('active');
                        
                        const carouselImg = document.createElement('img');
                        carouselImg.src = imageData.URL;
                        carouselImg.classList.add('d-block', 'w-100');
                        carouselItem.appendChild(carouselImg);
                        
                        carouselImages.appendChild(carouselItem);
                    });
                })
                .catch(error => {
                    console.error('Error fetching images:', error);
                });
        }

        // Clean up JSON response
        function cleanJSON(data) {
            return data.replace(/\\n/g, '').replace(/\\/g, '');
        }

        // Fetch hotel details and images on page load
        $(document).ready(function() {
            fetchHotelDetails();
            fetchHotelImages();
            fetchHotelImages1();
        });
        
        // Proceed to billing page
        function proceedToBilling() {
            setReloadFlag();
            window.location.href = "checkout.html";
        }
        
        // Set a reload flag in session storage
        function setReloadFlag() {
            sessionStorage.setItem('needsReload', 'true');
        }
        
        // Check if the page needs to reload
        function checkAndReload() {
            if (sessionStorage.getItem('needsReload') === 'true') {
                sessionStorage.removeItem('needsReload');
                location.reload();
            }
        }
        
        document.querySelector('button[onclick="proceedToBilling()"]').addEventListener('click', setReloadFlag);
        
        window.addEventListener('load', checkAndReload);
        
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                checkAndReload();
            }
        });
        
        // Clear local storage only on page refresh
        document.addEventListener('DOMContentLoaded', function() {
            if (performance.navigation.type === 1) {
                localStorage.removeItem('reservations');
                console.log('Local storage cleared due to page refresh');
            } else {
                console.log('Page loaded normally, local storage preserved');
            }
        });
    </script>
</body>
</html>
